
global
    log 127.0.0.1 format raw local0 debug
    # log stdout format raw local0 debug   # send logs to stdout with debug level
    maxconn 16536
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull 
    option  logasap
    option  http-server-close
    option  forwardfor if-none
    retries 3
    maxconn 2000
    timeout connect 5s
    timeout client  30s
    timeout server  30s

# Frontend configuration
frontend http_front
    bind *:80
    mode http
    
    # Grafana routing
    acl host_grafana hdr(host) -i dashboards.dev.pathfinder.local
    use_backend grafana_back if host_grafana

    # Prometheus routing
    acl host_prometheus hdr(host) -i metrics.dev.pathfinder.local
    use_backend prometheus_back if host_prometheus

    # Jaeger routing
    acl host_jaeger hdr(host) -i traces.dev.pathfinder.local
    use_backend jaeger_back if host_jaeger

    # Minio routing
    acl host_minio hdr(host) -i store.dev.pathfinder.local
    use_backend minio_back if host_minio

    # rabbitmq routing
    acl host_rabbitmq hdr(host) -i messages.dev.pathfinder.local
    use_backend rabbitmq_back if host_rabbitmq

    # influxdb-explorer routing
    acl host_influxdb hdr(host) -i timeseries.dev.pathfinder.local
    use_backend influxdb_back if host_influxdb

    # # Documentation routing
    # acl host_docs hdr(host) -i docs.dev.pathfinder.local
    # use_backend docs_back if host_docs

# Backend configurations
backend grafana_back
    mode http
    balance roundrobin
    server grafana grafana:3000 check init-addr last,libc,none

backend prometheus_back
    mode http
    balance roundrobin
    server prometheus prometheus:9090 check init-addr last,libc,none

backend minio_back
    mode http
    balance roundrobin
    server minio minio:9001 check init-addr last,libc,none

backend jaeger_back
    mode http
    balance roundrobin
    server jaeger jaeger:16686 check init-addr last,libc,none

backend rabbitmq_back
    mode http
    balance roundrobin
    server rabbitmq rabbitmq:15672 check init-addr last,libc,none

backend influxdb_back
    mode http
    balance roundrobin
    server influxdb influxdb-explorer:80 check init-addr last,libc,none

# backend docs_back
#     mode http
#     balance roundrobin
#     server docs docs:8000
listen stats
    bind *:8404                  # The port for the stats page
    mode http
    stats enable
    stats uri /stats                  # Access stats at http://<host>:8404/stats
    stats refresh 10s
    stats auth admin:admin       # username:password

# Prometheus metrics endpoint
frontend prometheus
    bind *:8405
    mode http
    
    # HAProxy's own metrics
    http-request use-service prometheus-exporter if { path /metrics }
    
    # Route metrics from other services
    acl path_vernemq path_beg /metrics/vernemq
    acl path_hivemq path_beg /metrics/hivemq
    acl path_rabbitmq path_beg /metrics/rabbitmq
    acl path_postgres path_beg /metrics/postgres
    acl path_minio path_beg /metrics/minio
    acl path_benthos_injector path_beg /metrics/benthos-injector
    acl path_benthos_writer path_beg /metrics/benthos-writer
    
    use_backend vernemq_metrics if path_vernemq
    use_backend hivemq_metrics if path_hivemq
    use_backend rabbitmq_metrics if path_rabbitmq
    use_backend postgres_metrics if path_postgres
    use_backend minio_metrics if path_minio
    use_backend benthos_injector_metrics if path_benthos_injector
    use_backend benthos_writer_metrics if path_benthos_writer
    
    no log

# Metrics backends
backend vernemq_metrics
    mode http
    http-request set-path /metrics
    server vernemq mqtt-broker:8888 check init-addr last,libc,none

backend hivemq_metrics
    mode http
    http-request set-path /metrics
    server hivemq mqtt-broker:9399 check init-addr last,libc,none

backend rabbitmq_metrics
    mode http
    http-request set-path /metrics
    server rabbitmq rabbitmq:15692 check init-addr last,libc,none

backend postgres_metrics
    mode http
    http-request set-path /metrics
    server postgres postgres-exporter:9187 check init-addr last,libc,none

backend minio_metrics
    mode http
    http-request set-path /minio/v2/metrics/cluster
    server minio minio:9000 check init-addr last,libc,none

backend benthos_injector_metrics
    mode http
    http-request set-path /benthos/metrics
    server benthos_injector data-injector:4195 check init-addr last,libc,none

backend benthos_writer_metrics
    mode http
    http-request set-path /benthos/metrics
    server benthos_writer timeseries-writer:4195 check init-addr last,libc,none
